---
title: Node-REDのHowTo(その1)
date: 2019-09-04
tags: ["Ubuntu","RaspberryPi","Node.js","Node-RED"]
excerpt: Node-REDのインストール他のメモ
layout: default
---

Node-REDをインストールや、フローを作成する際の手順のメモ。  
鶏頭で忘れっぽいのでメモ。  

# ubuntu に Node-RED をインストールする。

## Node.jsとnpmのインストール

自動起動とかやらないなら、Node.js は nodenv とか使っても良い気がするが、
念のためシステムに直接インストールしておく。  

``apt install`` だと古いバージョンになってしまうので、  
nコマンド をインストールし、  
nコマンドで安定版をインストールする。  
その後、``apt`` でインストールしたNode.jsは削除。  

```bash
# インストール
sudo apt install nodejs-legacy npm

# バージョン確認
node -v

# nコマンドのインストール
sudo npm install -g n

# 安定版のインストール
sudo n stable

# aptでインストールしたnode.jsをアンインストール
sudo apt purge -y nodejs-legacy npm

# バージョン確認
node -v
```

## Node-REDのインストール

```bash
sudo npm install -g --unsafe-perm node-red node-red-admin
```

どうも、ノードの追加とかすると、npmのキャッシュをアクセスするときにpermission deniedと言われてしまうみたいなので、
以下のコマンドで .npm ディレクトリ以下の所有権を自分にしておく。  
(キャッシュだから削除しても良い気がするが)

```bash
sudo chown -R `whoami`:`whoami` ~/.npm
```

## 起動

```bash
node-red
```

ブラウザで http://対象IPアドレス:1880 に接続


## 停止

CTRL-Cで停止する。  

## 参考

<https://qiita.com/seibe/items/36cef7df85fe2cefa3ea>  
<https://nodered.jp/docs/getting-started/local>


# Windows10 に Node-RED をインストールする。

## Node.js と npmの インストール

- [Node.jsのサイト](https://nodejs.org/ja/)からWindows版をダウンロードします。
    推奨版(2019/09/16現在、10.16.3 LTS)をダウンロードしてください。  
    (もし、別のプラットフォームのものが必要なら上部のメニューの「ダウンロード」からダウンロードします)  
- ダウンロードしたnode-vXX.XX.XX-YY.msiを実行してインストーラを起動し、インストールします。
    特に迷うところはないと思います。大体、そのまま「次へ」で大丈夫。
- インストールが終了したら、コマンドプロンプト または Windows PowerShell を起動します。
    念のため、``node -v`` を実行して、``v10.16.3``と表示されることを確認します。
    次にnpmのアップデートを行います。以下のコマンドを実行してください。( 2019/09/16現在、6.11.3 でした)

```
npm install -g npm
```
## Node-REDのインストール

- コマンドプロンプト または Windows PowerShell で以下のコマンドを実行してインストールします。
 
```
npm install -g --unsafe-perm node-red
```

- インストールが終了したら、コマンドプロンプト または Windows PowerShell で以下のコマンドを実行してNode-REDを起動します。  
実行したウィンドウは閉じないでください。閉じるとNode-REDが終了してしまいます。  

```
node-red
```

なお、初めてNode-REDを起動したとき、
『このアプリの機能のいくつかがWindows Defender ファイアウォールでブロックされています』
と警告が表示されることがある。  

この場合、
「通信を許可するネットワーク」を選択して「アクセスを許可する」をクリック
すれば良い。

## ちょっとヒトコトメモ

(ぜんぜんヒトコトじゃないけど。。。)

Node-REDを起動したPCからのアクセス(ブラウザ接続など)は成功するのに、
外部PCやRaspberryPi(もちろん、同一サブネット上の)からのアクセス(ブラウザやWebsocket接続)が失敗する場合がある。

考えられる原因は色々あるが、最も多そうな原因のひとつにファイアウォールでのブロックが考えられる。  
上の警告ダイアログでアクセス許可した際に、プライベートネットワークのみに通信を許可していて、
かつ、現在接続されているネットワークがパブリックネットワークである場合である。

ファイアウォールでのブロックされているかは**Node-REDを起動した状態**で以下のコマンドで確認できる。

- RaspberryPiの場合

以下のコマンドを実行

```bash
nc -zv 《IPアドレス》 《ポート番号》
```

例えば、こんな感じ。

```bash
nc -zv 192.168.1.2 1880
```

ブロックされていれば、コマンドが終了しないので、CTRL+Cで終了する。  
ブロックされていなければ(正常であれば)、``Connection to 《IPアドレス》 《ポート番号》port [tcp/*] succeeded!``と表示される。   

- Windowsの場合

Windows Poewrshellで(コマンドプロンプトでは不可)以下のコマンドを実行

```bash
Test-NetConnection 《IPアドレス》  -port 《ポート番号》
```

例えば、こんな感じ。

```bash
Test-NetConnection 192.168.1.2 -port 1880
```

ブロックされていれば、``TcpTestSucceeded : False``と表示される。  
ブロックされていなければ(正常であれば)、``TcpTestSucceeded : True``と表示される。  

これを解決するには、Node-REDを実行しているWindows PCで  
「コントロールパネル」→「Windows Defender ファイアウォール」を開き、  
左側のリストから「Windows Defender ファイアウォールを介したアプリまたは機能を許可」をクリック  
「設定の変更」をクリック
下のリストから「Node.js: Server-side JavaScript」の右側 パブリックのチェックボックスにチェックを入れる  
「OK」をクリック  

この状態で再度RaspberryPi または PCからファイアウォールでのブロックの確認を実行し、ブロックされていないことを確認してください。

# Raspbian に Node-RED をインストールする。

## Node.js と npm と Node-RED のインストール

インストールスクリプトを実行すればイッパツで解決。  

```bash
# インストールスクリプトの取得
wget  https://raw.githubusercontent.com/node-red/raspbian-deb-package/master/resources/update-nodejs-and-nodered

# 必要なら中身確認してね

# インストールスクリプトの実行
bash update-nodejs-and-nodered 
```

## 起動

```bash
node-red-start 
```
CTRL-Cでログ表示のみ止まる(Node-RED自体は動作したまま)  

ブラウザで http://対象IPアドレス:1880 に接続  

## ログ表示

Node-RED で console.log などを実行したときは、ログに表示される。  
``node-red-start``したままなら表示されるが、CTRL-Cでログ表示を止めていた場合は
以下のコマンドでログ表示を再開できる。  

```bash
node-red-log
```

## 停止

Node-RED自体を停止する。  

```bash
node-red-stop
```

## 参考

<https://qiita.com/utaani/items/7155c62d6c5e96822afb>  
<https://nodered.jp/docs/getting-started/local>

# フローの操作

## フローを保存する(エクスポート)

作成したフローは保存することができます。  
しばらく使わないフローを削除したり、別の環境にコピーする場合に保存しておくと良いでしょう。  

- 右上の3本線メニュー(≡) から「書き出し」→「クリップボード」をクリック →書き出しダイアログが表示される
    - 書き出す範囲を「現在のタブ」「すべてのタブ」から選択。(フローの一部を選択していた場合は「選択したフロー」も選択可能)  
    - その下にはその時のJSONファイルの内容が表示されていますので、ここから  
    - さらにその下で出力形式を「インデントのないJSONフォーマット」「インデント付きのJSONフォーマット」から選択。多少ファイルサイズが増減しますが、どちらを選んでも特に問題になるようなことはないでしょう。「インデント付き」の方が目視で確認しやすいと思います。  
    - 「ダウンロード」をクリックすると、ブラウザのファイル保存(ダウンロード)ダイアログが開くので、保存処理を行う(このときのファイル名はflows.json固定なので、必要に応じて保存後リネームしてください)  
    - または、「書き出し」をクリックすると、クリップボードへコピーされるので、直接 別の環境の読み込みダイアログやエディタへペーストすることも可能


## フローを読み込む(インポート)

保存したフローは読み込んで使用することができます(当然か)  

- 右上の3本線メニュー(≡) から「読み込み」→「クリップボード」をクリック →読み込みダイアログが表示される
    - 「読み込むファイルを選択してください」をクリックして読み込むファイルを選択 → ファイルの内容がその下のエディットボックスに表示される  
    - または、その下のエディットボックスにJSONデータをペースト
    - 読み込み先を「現在のタブ」「新規のタブ」から選択(「選択したフロー」で保存してないとどっちでも同じ気がする)  
    - 「読み込み」をクリック
- 読み込まれるので、内容を確認。必要なら修正。  
- デプロイする

## フローを削除する

使用しなくなったフローをいつまでも残しておくとトラブルの元ですから、削除しましょう。  
(念のため保存しておくのを忘れずに)  

- フローエディタの上部のタブで、削除したいフローのタブをダブルクリック→ 編集メニューが表示される
    - 左上の「削除」をクリック
- デプロイする(次回デプロイするまで処理は残っているので注意)


## フローを一時的に停止する

後で使うから削除したくはないけど、今デバッグしてる作業の邪魔になる、というような場合、
作成したフローを削除せずに一時的に停止することができます。  

- フローエディタの上部のタブで、停止したいフローのタブをダブルクリック→ 編集メニューが表示される
    - 状態を「無効」にする
    - 完了をクリック
- デプロイする(デプロイしないといつまで経っても停止しないので注意)

再開する場合は上記手順と同じで、状態を「有効」にする。  


## フローを全削除する

色々フローを作成したけど、一回チャラにしてやりなおしたいときは、
一旦Node-REDを停止(ブラウザ切断だけじゃなく、サーバプログラムを停止)して
以下の2つのファイルを削除する

- ~/.node-red/flows_《ホスト名》.json
- ~/.node-red/.flows_《ホスト名》.json.backup

もちろん、念のためバックアップ取っておくのが好ましい。  
バックアップから復元すれば元通りになるはず。  

その後、Node-Redを起動すると、フローが綺麗さっぱり消えているハズ。

## その2以降の「フローの例」について

「フローの例」に書かれたJSONコードはテスト用に作成したフローをエクスポート(書き出し)したものです。  
このコードの表示部分にマウスを乗せると、右上に「Copy」ボタンが表示されますので、このボタンをクリックしてください。JSONコードがクリップボードにコピーされます(マウスをドラッグしての選択は不要)。  

この状態で、上記**フローを読み込む(インポート)**に示した方法でフローをインポートするとフローがコピーされます。  

>[!NOTE]
> 複数のフローをインポートした場合、既に存在するノードと同名のノードは別のノードとして生成されます。このとき、名前に「(_1)」などの別ノードを識別できるような記号は付きません。  
> 特に、WebsocketのノードやDashboardのタブ/グループはシステムの動作や見た目に影響しますので、注意してください。  
> 自動でよしなにする方法はありませんので、手動でチマチマと修正してください。  
> サイドバー(右側のペイン)の「▼」ボタンをクリックし、ノードの設定を表示でノードの設定を表示し、  
> 各ノードの右側の数字をクリックすると、そのノードを参照しているノードの一覧が表示されます。  
> さらにそのノード一覧の各ノードをダブルクリックすると、そのノードが点滅表示されるので、そのノードのプロパティで参照先を変更すれば良いでしょう。  
>


