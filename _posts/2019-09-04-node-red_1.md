---
title: Node-REDのHowTo
date: 2019-09-04
tags: ["Ubuntu","RaspberryPi","Node.js","Node-RED"]
excerpt: Node-REDのインストール他のメモ
layout: default
---



# ubuntu に Node-RED をインストールする。

## Node.jsとnpmのインストール

自動起動とかやらないなら、Node.js は nodenv とか使っても良い気がするが、
念のためシステムに直接インストールしておく。  

``apt install`` だと古いバージョンになってしまうので、  
nコマンド をインストールし、  
nコマンドで安定版をインストールする。  
その後、``apt`` でインストールしたNode.jsは削除。  

```bash
# インストール
sudo apt install nodejs-legacy npm

# バージョン確認
node -v

# nコマンドのインストール
sudo npm install -g n

# 安定版のインストール
sudo n stable

# aptでインストールしたnode.jsをアンインストール
sudo apt purge -y nodejs-legacy npm

# バージョン確認
node -v
```

## Node-REDのインストール

```bash
sudo npm install -g --unsafe-perm node-red node-red-admin
```

どうも、ノードの追加とかすると、npmのキャッシュをアクセスするときにpermission deniedと言われてしまうみたいなので、
以下のコマンドで .npm ディレクトリ以下の所有権を自分にしておく。  

```bash
sudo chown -R <<自分のユーザ名>>:<<自分のユーザ名>> ~/.npm
```

## 起動

```bash
node-red
```

ブラウザで http://対象IPアドレス:1880 に接続

## 参考

<https://qiita.com/seibe/items/36cef7df85fe2cefa3ea>  
<https://nodered.jp/docs/getting-started/local>



# Raspbian に Node-RED をインストールする。

## Node.js と npm と Node-RED のインストール

インストールスクリプトを実行すればイッパツで解決。  

```bash
# インストールスクリプトの取得
wget  https://raw.githubusercontent.com/node-red/raspbian-deb-package/master/resources/update-nodejs-and-nodered

# 必要なら中身確認してね

# インストールスクリプトの実行
bash update-nodejs-and-nodered 
```


## 起動

```bash
node-red-start 
```
CTRL-Cでログ表示のみ止まる(Node-RED自体は動作したまま)  

ブラウザで http://対象IPアドレス:1880 に接続  

## ログ表示

Node-RED で console.log などを実行したときは、ログに表示される。  
``node-red-start``したままなら表示されるが、CTRL-Cでログ表示を止めていた場合は
以下のコマンドでログ表示を再開できる。  

```bash
node-red-log
```

## 停止

Node-RED自体を停止する。  

```bash
node-red-stop
```


## 参考

<https://qiita.com/utaani/items/7155c62d6c5e96822afb>  
<https://nodered.jp/docs/getting-started/local>



# Dashboardをインストールする。

- ブラウザでNode-REDに接続した状態で、右上の3本線メニュー(≡) から「パレットの管理」をクリック
- 画面上部の「ノードを追加」をクリック
- ノードを検索の部分に「node-red-dashboard」と入力
- 下に検索結果が出るので。「node-red-dashboard」の「ノードを追加」をクリック
- 何やらダイアログが出るので、「追加」をクリック
- 完了したら「閉じる」をクリック。

# Dashboard のフローを作成する
- パレット(左側のペイン)の「dashboard」の下の「button」 をフローにドラッグ&ドロップ
- ドロップした「button」をダブルクリック → 編集メニューが表示される
    - Group で「新規に ui_group を追加...」を選択してその右の編集ボタンをクリック
        - 名前は適当に設定
        - タブ で「新規に ui_tab を追加...」を選択してその右の編集ボタンをクリック
            - 適当に値を設定する
            - 右上の「追加」をクリック
        - 右上の「追加」をクリック
    - Group に 今設定したグループとタブが選択されていることを確認
    - label で表示名を変更
    - Payload に クリックされたときに送信するデータを設定
    - 右上の「完了」をクリック

- 次段以降のノードを追加
- デプロイする

- ブラウザで、http://対象IPアドレス:1880/ui に接続
    - Dashboardが表示されるハズ
    - ボタンをクリックしたらフローが動作する。

# Websocketでデータを送信する

- パレットの「出力」の下の「websocket」 をフローにドラッグ&ドロップ
- ドロップした「websocket」をダブルクリック → 編集メニューが表示される
    - パス で 「新規に websocket-listner を追加」を選択してその右の編集ボタンをクリック
        - パス を適当に設定(/ws/data01 など)
            - Websocket の Listen port のポート番号は Node-RED のポート番号と同じになるので、Client側で指定するURLはそのポート番号を指定すること
        - 追加をクリック
    - パス に 今設定したパスが表示されていることを確認
    - 必要なら名前を設定
    - 完了をクリック

- トリガとなるノードを接続
- デプロイする

# Websocketでデータを受信する

- パレットの「入力」の下の「websocket」 をフローにドラッグ&ドロップ
- ドロップした「websocket」をダブルクリック → 編集メニューが表示される
    - 種類で「接続」を選択
    - URL で 「新規に websocket-client を追加」を選択してその右の編集ボタンをクリック
        - URL でサーバのURLを設定( ws://PiDev25.local:1880/ws/data01 など)
        - 追加をクリック
    - 必要なら名前を設定
    - 完了をクリック

- 受信したメッセージを処理するノードを接続
- デプロイする

