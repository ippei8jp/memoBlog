---
title: pyenvのバグ？？
date: 2020-06-29
tags: ["Ubuntu","RaspberryPi","python"]
excerpt: pyenvのバグ？？
layout: default
---

バグかどうかわからんけど、思った通りの動作をしなかったので、メモ。  

# 現象

pyenv を使う環境で、

```bash
    python script.py --option /path/to/file
```

と実行した場合、カレントディレクトリと``/path/to/file``の存在するディレクトリで使用するpythonのバージョンが異なる場合、  
(どちらか片方 or 両方で ``pyenv local``が指定されている)  
カレントディレクトリではなく、/path/to/fileの存在するディレクトリで使用するpythonのバージョンが指定されてしまうらしい。  

問題が発生するシチュエーションは そんなに多くないと思うけど、 双方のバージョンでインストールしてるモジュールが違ったりすると困ったことになる。  

# 原因

色々試行錯誤してみてわかったことを結論だけ。  

``～～～/.pyenv/shims/python`` を見ると、  
コマンドラインをサーチして最初に見つかったファイルの属する``.python-version``を読むらしい。  
(以下の部分)  

```bash
    ・・・
    case "$arg" in
        -c* | -- ) break ;;
        */* )
            if [ -f "$arg" ]; then
                export PYENV_FILE_ARG="$arg"
                break
            fi
            ;;
    esac
    ・・・
```
本来ならスクリプトファイルのあるディレクトリの``.python-version``を読んでほしいはずなのに...  
`` */* ) `` でなく、`` *) `` じゃないのかな？ なんか深い訳があるのかもしれんけど...

# 対処方法

で、以下のいずれかの方法で対処できる。  

- オプションの場合は、オプションとオプションパラメータの間をスペースでなく、``=``にする  
```bash
    python script.py --option=/path/to/file
```
    - ただし、パーサが``argparse.ArgumentParser``など、オプションとオプションパラメータの区切りに``=``が使えるものでなければダメ。  
    - しかも、そもそもオプションパラメータでなくコマンドパラメータだったらどうしようもない...orz...

- ``pyenv shell``で使用するバージョンを指定する  
   - メンドクサイ...

- スクリプトファイルの前に``--``を追加してやる。  
```bash
python -- script.py /path/to/file
````
  -  ``～～～/.pyenv/shims/python`` では``-c``か``--``が見つかったら``PYENV_FILE_ARG``を探すループを抜けてくれるので。  
  - ちょっとめんどくさい...   

- スクリプト名の前に./を追加する  
```bash
python ./script.py /path/to/file
```
  - これが一番シンプルかな？  
  - てか、コレしかないっしょ。 常に``./``付けるクセ付ければいいし。  


# 免責(のツモリ)

あくまで自分のメモなんで、、、  ゴニョゴニョ...  

